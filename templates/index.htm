<!DOCTYPE html>
<html lang="pt-br">
<head>
	<title>risk-data</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
	<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-theme.min.css') }}">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style type="text/css">
		body{
			padding-top: 65px;
		}

		#info-left{
			padding-top: 65px;	
		}

		input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button{
			-webkit-appearance: none;
			margin: 0; 
		}

		.loader{font-size:90px;text-indent:-9999em;overflow:hidden;width:1em;height:1em;border-radius:50%;margin:72px auto;position:relative;-webkit-transform:translateZ(0);-ms-transform:translateZ(0);transform:translateZ(0);-webkit-animation:load6 1.7s infinite ease;animation:load6 1.7s infinite ease}@-webkit-keyframes load6{0%{-webkit-transform:rotate(0);transform:rotate(0);box-shadow:0 -.83em 0 -.4em #000,0 -.83em 0 -.42em #000,0 -.83em 0 -.44em #000,0 -.83em 0 -.46em #000,0 -.83em 0 -.477em #000}5%,95%{box-shadow:0 -.83em 0 -.4em #000,0 -.83em 0 -.42em #000,0 -.83em 0 -.44em #000,0 -.83em 0 -.46em #000,0 -.83em 0 -.477em #000}10%,59%{box-shadow:0 -.83em 0 -.4em #000,-.087em -.825em 0 -.42em #000,-.173em -.812em 0 -.44em #000,-.256em -.789em 0 -.46em #000,-.297em -.775em 0 -.477em #000}20%{box-shadow:0 -.83em 0 -.4em #000,-.338em -.758em 0 -.42em #000,-.555em -.617em 0 -.44em #000,-.671em -.488em 0 -.46em #000,-.749em -.34em 0 -.477em #000}38%{box-shadow:0 -.83em 0 -.4em #000,-.377em -.74em 0 -.42em #000,-.645em -.522em 0 -.44em #000,-.775em -.297em 0 -.46em #000,-.82em -.09em 0 -.477em #000}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg);box-shadow:0 -.83em 0 -.4em #000,0 -.83em 0 -.42em #000,0 -.83em 0 -.44em #000,0 -.83em 0 -.46em #000,0 -.83em 0 -.477em #000}}@keyframes load6{0%{-webkit-transform:rotate(0);transform:rotate(0);box-shadow:0 -.83em 0 -.4em #000,0 -.83em 0 -.42em #000,0 -.83em 0 -.44em #000,0 -.83em 0 -.46em #000,0 -.83em 0 -.477em #000}5%,95%{box-shadow:0 -.83em 0 -.4em #000,0 -.83em 0 -.42em #000,0 -.83em 0 -.44em #000,0 -.83em 0 -.46em #000,0 -.83em 0 -.477em #000}10%,59%{box-shadow:0 -.83em 0 -.4em #000,-.087em -.825em 0 -.42em #000,-.173em -.812em 0 -.44em #000,-.256em -.789em 0 -.46em #000,-.297em -.775em 0 -.477em #000}20%{box-shadow:0 -.83em 0 -.4em #000,-.338em -.758em 0 -.42em #000,-.555em -.617em 0 -.44em #000,-.671em -.488em 0 -.46em #000,-.749em -.34em 0 -.477em #000}38%{box-shadow:0 -.83em 0 -.4em #000,-.377em -.74em 0 -.42em #000,-.645em -.522em 0 -.44em #000,-.775em -.297em 0 -.46em #000,-.82em -.09em 0 -.477em #000}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg);box-shadow:0 -.83em 0 -.4em #000,0 -.83em 0 -.42em #000,0 -.83em 0 -.44em #000,0 -.83em 0 -.46em #000,0 -.83em 0 -.477em #000}}
	</style>
	<script type="text/javascript">
		var data = {};
		var calculatedFields = new Array();

		$(document).ready(function(){
			$.ajax({
				type: "GET",
				url: "/fields",
				contentType: 'application/json',
				dataType: 'json',
				success: function(e){
					var fieldsJSON;
					console.log("success");
					fieldsJSON = JSON.parse(e.data);
					console.log(fieldsJSON);
					createFields(fieldsJSON.fields);
				},
				failure: function(e){
					console.log("fail");
				}
			});

			$("#submit-btn").click(function(){
				$("#container-form").hide();
				$(".loader").show();
				$(".form-group input[type=text], .form-group input[type=number], .form-group select, .form-group input[type=radio]").each(function(){
					var inputID = $(this).attr("id").split("-")[0]; //Divide ID do input[type=text] em dois e pega a primeira parte antes do do hífen
					var inputValue = $(this).val().replace(',','.');
					data[inputID] = inputValue + "";
				});

				createEvalForCalculatedFields();
				calculatedFields.forEach(function(field){
					var inputID = field.id;
					var inputValue = eval(field.formula);
					data[inputID] = inputValue + "";
				});

				console.log(data);

				$.ajax({
					type: "POST",
					url: "/result",
					contentType: 'application/json',
					dataType: 'json',
					data: JSON.stringify(data),
					success: function(e){
						console.log("success");
						console.log(e);
						$(".loader").hide();
						$("#container-result").show();
						if(e.result == "a-dm-true" || e.result == "a-dm-false" || e.result == "error")
							$("#" + e.result).show();
						else
							$("#error").show();
					},
					failure: function(e){
						console.log("fail");
					}
				});
			});
		});

		var createFields = function(fieldsArray){
			if(fieldsArray.length > 0){
				fieldsArray.forEach(function(field){
					if(field.active){
						switch(field.type){
							case "text":
								$("form").prepend('<div data-tooltip="'+field.tooltip+'" class="form-group" id="'+ field.id +'-div"><input type="text" class="form-control" id="'+ field.id +'-input" placeholder="'+ field.name +'"></div>');
								break;
							case "number":
								$("form").prepend('<div data-tooltip="'+field.tooltip+'" class="form-group" id="'+ field.id +'-div"><input type="number" step="0.01" min="0" class="form-control" id="'+ field.id +'-input" placeholder="'+ field.name +'"></div>');
								break;
							case "select":
								$("form").prepend('<div data-tooltip="'+field.tooltip+'" class="form-group" id="'+ field.id +'-div"><label for="'+ field.id +'-input">'+ field.name +'</label><select class="form-control" id="'+ field.id +'-input"></select></div>');
								field.values.forEach(function(value){
									$("#" + field.id + "-input").append("<option value='" + value.value + "'>" + value.mask + "</option>");
								});
								break;
							case "radio":
								var count = 0;
								var radios = "";
								field.values.forEach(function(value){
									radios += '<label class="radio-inline"><input type="radio" name="'+ field.id +'" id="'+ field.id + "-" + count +'" value="'+ value.value +'"> '+ value.mask +'</label>';
									count++;
								});
								$("form").prepend('<div data-tooltip="'+field.tooltip+'" class="form-group" id="'+ field.id +'-div"><label for="'+ field.id +'-input">'+ field.name +'</label><br>'+ radios +'</div>');
								break;
							case "calculated":
								calculatedFields.push(field);
								break;
						}
						if(field.tooltip != ""){
							console.log("Kappa");
							$("#" + field.id + "-div").mouseover(function(){
								$("#tooltip-header").html(field.name);
								$("#tooltip-body").html(field.tooltip);
								$("#tooltip").show();
							});
							$("#" + field.id + "-div").mouseleave(function(){
								$("#tooltip").hide();
							});
						}
					}
				});
			}else{
				$("#button-container").hide();
				$("form").prepend("<h1>JSON dos campos vazio</h1>");
			}
		}

		var createEvalForCalculatedFields = function(){
			calculatedFields.forEach(function(field){
				field.vars.forEach(function(inputVar){
					field.formula = field.formula.replace(RegExp(inputVar,"g"), $("#" + inputVar + "-input").val().replace(',','.'));
					console.log(field.formula);
				});
				console.log(field.formula);
			});
		}
	</script>
</head>
<body>
	<nav class="navbar navbar-inverse navbar-fixed-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">risk-data</a>
			</div>
		</div>
	</nav>
	<div class="container-fluid">
		<div class="row" id="container-form">
			<div class="col-md-4">
				<div class="container-fluid" id="info-left">
					<div class="row" id="tooltip" style="display: none;">
						<div class="col-md-1"></div>
						<div class="col-md-10">
							<div class="panel panel-primary">
								<div class="panel-heading" id="tooltip-header"></div>
								<div class="panel-body" id="tooltip-body"></div>
							</div>
						</div>
						<div class="col-md-1"></div>
					</div>
				</div>
			</div>
			<div class="col-md-4">
				<form class="form-horizontal">
					<div class="form-group" id="button-container">
						<button type="button" class="btn btn-default" id="submit-btn">Calcular</button>
						<button type="reset" class="btn btn-default">Limpar</button>
					</div>
				</form>
			</div>
			<div class="col-md-4"></div>
		</div>
		<div class="loader" style="display: none;">Loading...</div>
		<div class="row" id="container-result" style="display: none;">
			<div class="col-md-4"></div>
			<div class="col-md-4">
				<h3 id="a-dm-true" style="display:none;">Você está no grupo de risco de diabetes segundo o nosso modelo</h3>
				<h3 id="a-dm-false" style="display:none;">Você não está no grupo de risco de diabetes segundo o nosso modelo</h3>
				<h3 id="error" style="display:none;">Error</h3>
			</div>
			<div class="col-md-4"></div>
		</div>
	</div>
</body>
</html>
